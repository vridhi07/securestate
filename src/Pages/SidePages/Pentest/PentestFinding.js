import React, { useState, useEffect } from "react";
import SearchIcon from "@mui/icons-material/Search";
import FormControl from "@mui/material/FormControl";
import InputLabel from "@mui/material/InputLabel";
import Select from "@mui/material/Select";
import MenuItem from "@mui/material/MenuItem";
import DarkGrayButton from "../../../Component/Common/DarkGrayButton";
import PentestFindingTitle from "../../../Component/Pentest/PentestFindingTitle";
import FindingMOdal from "../../../Component/Pentest/FindingModal";
import { useSelector, useDispatch } from "react-redux";
import * as action from "../../../Redux/action";
import { useLocation } from "react-router-dom";
import DeleteModal from "../../../Component/Common/DeleteModal";
import * as Roles from "../../../constantData/Roles";
const PentestFinding = () => {
  const [findingFilter, setFindingFilter] = useState("Severity");
  const [findingSearch, setFindingSearch] = useState("");
  const [isEdit, setIsEdit] = useState(false);
  const [isFindingModalOpen, setIsFindingModalOpen] = useState(false);
  const [findingForm, setFindingForm] = useState({
    findingTitle: "",
    status: "",
    severity: "",
    risk: "",
    complexity: "",
    CVSSscore: "",
    findingDetails: "",
    findingRecommendation: "",
  });
  const [files, setFiles] = useState("");
  const [findingData, setFindingData] = useState([]);
  const [seletedId, setSelectedId] = useState(null);
  const [expanded, setExpanded] = useState("panel0");
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);

  //  isDeleteModalOpen,
  // closeDeleteModal,
  // handleDelete,

  const handleChange = (panel) => (event, isExpanded) => {
    setExpanded(isExpanded ? panel : false);
  };

  // *REDUX
  const dispatch = useDispatch();
  const { findings } = useSelector((state) => state?.pentestTab);
  const { userRole } = useSelector((state) => state?.user);
  let ArrayLength = findings && findings.length;
  // * React router Info
  const Access = Roles.handleClientAccess(userRole);
  const location = useLocation();
  // console.log(location);
  const pentestId = location?.state?.id;
  // console.log(pentestId);
  // * Functions
  const handleFindingFormChange = (e) => {
    let name = e.target.name;
    let value = e.target.value;
    if (name === "CVSSscore") {
      let min = 0;
      let max = 100;
      if (value > max) value = max;
      if (value < min) value = min;
    }

    setFindingForm({ ...findingForm, [name]: value });
  };
  const handleFindingEdit = (id) => {
    let singleData = findingData.find((item) => item._id === id);
    setFindingForm({
      ...findingForm,
      findingTitle: singleData.title,
      status: singleData.status,
      severity: singleData.severity,
      risk: singleData.risk,
      complexity: singleData.complexity,
      CVSSscore: singleData.cvss,
      findingDetails: singleData.details,
      findingRecommendation: singleData.recommendation,
    });
    // console.log(singleData);
    setExpanded(false);
    // console.log(id);
    setSelectedId(id);

    setIsEdit(true);
    setIsFindingModalOpen(true);
  };

  const handleClickOpen = () => {
    setIsFindingModalOpen(true);
  };

  const handleClose = () => {
    setIsFindingModalOpen(false);

    setFindingForm({
      ...findingForm,
      findingTitle: "",
      status: "",
      severity: "",
      risk: "",
      complexity: "",
      CVSSscore: "",
      findingDetails: "",
      findingRecommendation: "",
    });
    if (isEdit) {
      setTimeout(() => {
        setIsEdit(false);
      }, 1000);
    }
  };

  const openDeleteModal = (id) => {
    setIsDeleteModalOpen(true);
    // console.log(id);
    setSelectedId(id);
    handleClose();
    if (expanded) {
      setExpanded(false);
    }
  };
  const handleSubmit = (e) => {
    e.preventDefault();
    const {
      findingTitle,
      status,
      severity,
      risk,
      complexity,
      CVSSscore,
      findingDetails,
      findingRecommendation,
    } = findingForm;
    if (isEdit) {
      let data = new FormData();
      data.append("status", status);
      data.append("severity", severity);
      data.append("risk", risk);
      data.append("complexity", complexity);
      data.append("cvss", CVSSscore);
      data.append("details", findingDetails);
      data.append("recommendation", findingRecommendation);
      data.append("title", findingTitle);
      if (files) {
        data.append("file", files, files.name);
      }
      dispatch(action.updateFindingsRequest({ data, pentestId, seletedId }));
    }
    if (!isEdit) {
      let data = new FormData();
      data.append("status", status);
      data.append("severity", severity);
      data.append("risk", risk);
      data.append("complexity", complexity);
      data.append("cvss", CVSSscore);
      data.append("details", findingDetails);
      data.append("recommendation", findingRecommendation);
      data.append("title", findingTitle);
      // console.log("add");
      if (files) {
        data.append("file", files, files.name);
      }
      dispatch(action.addFindingsRequest({ data, pentestId }));
    }
    handleClose();
    setFiles("");
  };
  const closeDeleteModal = () => {
    setIsDeleteModalOpen(false);
    setSelectedId(null);
  };
  const handleDelete = () => {
    // console.log("delete");
    dispatch(action.deleteFindingsRequest({ pentestId, seletedId }));
    closeDeleteModal();
  };
  const getFilterData = (data, filterOption, searchOption) => {
    let newData = [...data];

    if (filterOption === "Severity") {
      newData = newData.sort((a, b) => {
        const orders = { Low: 0, Medium: 1, High: 2, Critical: 3 };
        return orders[b.severity] - orders[a.severity];
      });
    }
    if (filterOption === "Risk") {
      newData = newData.sort((a, b) => {
        const orders = { Low: 0, Medium: 1, High: 2, Critical: 3 };
        return orders[b.risk] - orders[a.risk];
      });
    }
    if (filterOption === "Complexity") {
      newData = newData.sort((a, b) => {
        const orders = { Low: 0, Medium: 1, High: 2 };
        return orders[b.complexity] - orders[a.complexity];
      });
    }
    if (filterOption === "Status") {
      newData = newData.sort((a, b) => {
        const orders = {
          Open: 0,
          "Fixed Verified": 1,
          Fix: 2,
          Failed: 3,
          "Verify Fix": 4,
          "Accept Risk": 5,
        };
        return orders[a.status] - orders[b.status];
      });
    }
    if (searchOption) {
      newData = newData.filter((item) => {
        return item.title.toLowerCase().startsWith(searchOption);
      });
    }

    return newData;
  };

  let filterData;
  if (findings) {
    filterData = getFilterData(findingData, findingFilter, findingSearch);
  }
  // console.log(filterData);
  useEffect(() => {
    if (findings) {
      setFindingData([...findings]);
    }
  }, [findings]);

  return (
    <div className="flex w-full flex-col  items-center ">
      <section className="my-6 flex w-full flex-col lg:flex-row lg:items-center lg:justify-between ">
        <form className="grid items-center justify-center">
          <div
            className="flex items-center justify-end rounded-3xl border 
          border-gray-600 bg-white py-0.5 pr-2
          "
          >
            <SearchIcon sx={{ ml: "0.5rem", mt: "0.2rem" }} />
            <input
              type="search"
              className="bg-clip-padding py-1 px-1 placeholder:text-gray-600 focus:outline-none"
              placeholder="Search"
              value={findingSearch}
              onChange={(e) => setFindingSearch(e.target.value)}
            />
          </div>
        </form>
        <div className="mt-3 flex flex-col items-center justify-center lg:mt-0 lg:flex-row">
          <form className="min-w-[16rem] lg:min-w-[13rem]">
            <FormControl fullWidth size="small">
              <InputLabel id="findingFilter">filter</InputLabel>
              <Select
                labelId="findingFilter"
                id="findingFilter"
                value={findingFilter}
                label="filter"
                onChange={(e) => setFindingFilter(e.target.value)}
              >
                <MenuItem value={"Severity"}>Severity</MenuItem>
                <MenuItem value={"Risk"}>Risk</MenuItem>
                <MenuItem value={"Complexity"}>Complexity</MenuItem>
                <MenuItem value={"Status"}>Status</MenuItem>
              </Select>
            </FormControl>
          </form>
          {Access && (
            <div className="mt-3 lg:ml-3 lg:mt-0">
              <DarkGrayButton
                onClick={handleClickOpen}
                className={"px-[4.8rem] lg:px-[3rem]"}
              >
                Add Findings
              </DarkGrayButton>
            </div>
          )}
        </div>
      </section>
      <section className="flex w-full flex-col pb-12">
        {filterData && filterData.length === 0 ? (
          <div className="mt-10 flex w-full items-center justify-center text-center">
            <h4 className="text-lg capitalize">no data found</h4>
          </div>
        ) : (
          filterData.map((item, index) => {
            return (
              <PentestFindingTitle
                key={item._id}
                index={index}
                item={item}
                handleFindingEdit={handleFindingEdit}
                expanded={expanded}
                handleChange={handleChange}
                openDeleteModal={openDeleteModal}
                Access={Access}
              />
            );
          })
        )}
      </section>
      <FindingMOdal
        handleClose={handleClose}
        isFindingModalOpen={isFindingModalOpen}
        isEdit={isEdit}
        handleFindingFormChange={handleFindingFormChange}
        findingForm={findingForm}
        files={files}
        setFiles={setFiles}
        handleSubmit={handleSubmit}
        ArrayLength={ArrayLength}
      />
      <DeleteModal
        isDeleteModalOpen={isDeleteModalOpen}
        closeDeleteModal={closeDeleteModal}
        handleDelete={handleDelete}
      />
    </div>
  );
};

export default PentestFinding;
